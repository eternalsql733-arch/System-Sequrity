<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ MFA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .instructions {
            background: #f0f8ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code {
            max-width: 200px;
            height: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: white;
        }
        
        .secret-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 16px;
            text-align: center;
            margin: 15px 0;
            border: 1px dashed #ddd;
            word-break: break-all;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 3px;
            font-family: monospace;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
            width: 100%;
            padding: 14px;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .nav-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }
        
        .step-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-weight: bold;
        }
        
        .step-indicator.active {
            background: #007bff;
            color: white;
        }
        
        .step-line {
            flex: 1;
            height: 2px;
            background: #ddd;
            margin-top: 14px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="nav-steps">
            <div class="step-indicator {% if step == 'setup' %}active{% endif %}">1</div>
            <div class="step-line"></div>
            <div class="step-indicator {% if step == 'verify' %}active{% endif %}">2</div>
        </div>
        
        <!-- –®–∞–≥ 1: –ù–∞—á–∞–ª–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="step {% if step == 'setup' %}active{% endif %}" id="stepSetup">
            <div class="instructions">
                <h3>üì± –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</h3>
                <p>–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MFA –≤–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:</p>
                <ol>
                    <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <strong>Google Authenticator</strong> –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω</li>
                    <li>–ò–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TOTP –∫–æ–¥–æ–≤</li>
                </ol>
            </div>
            
            <form method="POST">
                <input type="hidden" name="action" value="setup">
                <button type="submit" class="btn btn-primary">
                    –ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É ‚Üí
                </button>
            </form>
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="{{ url_for('index') }}" style="color: #666; text-decoration: none;">
                    ‚Üê –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                </a>
            </div>
        </div>
        
        <!-- –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ -->
        <div class="step {% if step == 'verify' %}active{% endif %}" id="stepVerify">
            <div class="instructions">
                <h3>üîó –ü—Ä–∏–≤—è–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
                <p>–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</p>
                <ol>
                    <li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Authenticator</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" –∏–ª–∏ "+"</li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥"</li>
                    <li>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –∫–æ–¥ –Ω–∏–∂–µ</li>
                </ol>
            </div>
            
            {% if qr_code %}
            <div class="qr-container">
                <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code" class="qr-code">
            </div>
            
            <div class="secret-box">
                {{ secret }}
            </div>
            
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é: <strong>{{ secret }}</strong>
            </p>
            {% endif %}
            
            <form method="POST">
                <input type="hidden" name="action" value="verify">
                {% if secret %}
                <input type="hidden" name="secret" value="{{ secret }}">
                {% endif %}
                
                <div class="form-group">
                    <label for="token">–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</label>
                    <input type="text" 
                           id="token" 
                           name="token" 
                           maxlength="6" 
                           pattern="\d{6}" 
                           placeholder="123456"
                           required 
                           autofocus
                           autocomplete="off">
                </div>
                
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="goToStep('setup')" style="flex: 1;">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 2;">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –≤–∫–ª—é—á–∏—Ç—å MFA
                    </button>
                </div>
            </form>
            
            <div class="debug-info" style="display: none;">
                <p><strong>–û—Ç–ª–∞–¥–∫–∞:</strong> –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ–∫—Ä–µ—Ç: {{ secret }}</p>
                <p>–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: {{ current_time }}</p>
            </div>
        </div>
    </div>
    
    <script>
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
        function goToStep(stepName) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step' + stepName.charAt(0).toUpperCase() + stepName.slice(1)).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
            document.querySelectorAll('.step-indicator').forEach(indicator => {
                indicator.classList.remove('active');
            });
            
            if (stepName === 'setup') {
                document.querySelectorAll('.step-indicator')[0].classList.add('active');
            } else {
                document.querySelectorAll('.step-indicator')[1].classList.add('active');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –≤–≤–æ–¥–µ 6 —Ü–∏—Ñ—Ä
        const tokenInput = document.getElementById('token');
        if (tokenInput) {
            tokenInput.addEventListener('input', function(e) {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ-—Ü–∏—Ñ—Ä—ã
                this.value = this.value.replace(/\D/g, '');
                
                if (this.value.length === 6) {
                    setTimeout(() => {
                        this.form.submit();
                    }, 300);
                }
            });
            
            // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤–≤–æ–¥ –Ω–µ-—Ü–∏—Ñ—Ä
            tokenInput.addEventListener('keypress', function(e) {
                if (!/\d/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete') {
                    e.preventDefault();
                }
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        function toggleDebug() {
            const debugInfo = document.querySelector('.debug-info');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —à–∞–≥—É verify –µ—Å–ª–∏ –µ—Å—Ç—å QR –∫–æ–¥
        {% if qr_code and step == 'verify' %}
        document.addEventListener('DOMContentLoaded', function() {
            goToStep('verify');
            if (tokenInput) {
                tokenInput.focus();
            }
        });
        {% endif %}
    </script>
</body>
</html>